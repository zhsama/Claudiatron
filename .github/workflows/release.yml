name: Build and Release

on:
  push:
    tags:
      - 'v*'  # å½“æŽ¨é€ v* æ ‡ç­¾æ—¶è§¦å‘ (å¦‚: v1.0.0)
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      version:
        description: 'Release version (å¦‚: v1.0.0)'
        required: true
        default: 'v0.1.0'

permissions:
  contents: write

jobs:
  release:
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
          - os: windows-latest
            platform: win
          - os: macos-latest
            platform: mac
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²ç”¨äºŽç”Ÿæˆ changelog
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: Build & Release for ${{ matrix.platform }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # å¢žåŠ æž„å»ºè¶…æ—¶æ—¶é—´å’Œä¼˜åŒ–é€‰é¡¹
          NODE_OPTIONS: '--max-old-space-size=4096'
        timeout-minutes: 30
        run: |
          echo "Building for ${{ matrix.platform }}..."
          pnpm build:${{ matrix.platform }}

  # åˆ›å»º GitHub Release
  create-release:
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
    needs: release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi
          
      - name: Get previous tag
        id: prev_tag
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
          echo "PREV_TAG=$PREV_TAG" >> $GITHUB_OUTPUT
          echo "Previous tag: $PREV_TAG"
          
      - name: Generate release notes
        id: release_notes
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          PREV_TAG="${{ steps.prev_tag.outputs.PREV_TAG }}"
          
          cat > release_notes.md << 'EOF'
          ## ðŸš€ Claudiatron $VERSION
          
          ### ðŸ“¦ ä¸‹è½½ / Downloads
          
          é€‰æ‹©é€‚åˆæ‚¨æ“ä½œç³»ç»Ÿçš„ç‰ˆæœ¬ï¼š/ Choose the version for your operating system:
          
          | æ“ä½œç³»ç»Ÿ / OS | æ–‡ä»¶ / File | è¯´æ˜Ž / Description |
          |---------------|-------------|-------------------|
          | Windows | `Claudiatron-$VERSION.exe` | Windows å®‰è£…ç¨‹åº / Windows installer |
          | macOS | `Claudiatron-$VERSION.dmg` | macOS ç£ç›˜æ˜ åƒ / macOS disk image |
          | Linux | `Claudiatron-$VERSION.AppImage` | Linux ä¾¿æºç‰ˆ / Linux portable |
          | Linux | `Claudiatron-$VERSION.deb` | Ubuntu/Debian è½¯ä»¶åŒ… / Ubuntu/Debian package |
          
          ### ðŸ“‹ æ›´æ–°å†…å®¹ / What's New
          
          EOF
          
          # ç”Ÿæˆæ›´æ–°æ—¥å¿—
          if [ -n "$PREV_TAG" ]; then
            echo "**è‡ª $PREV_TAG ä»¥æ¥çš„æ›´æ”¹ / Changes since $PREV_TAG:**" >> release_notes.md
            echo "" >> release_notes.md
            
            # èŽ·å–æäº¤ä¿¡æ¯å¹¶æŒ‰ç±»åž‹åˆ†ç±»
            git log $PREV_TAG..HEAD --pretty=format:"- %s" --no-merges | \
            sed 's/^- //' | \
            while IFS= read -r commit; do
              case "$commit" in
                *"feat:"*|*"âœ¨"*)
                  echo "### âœ¨ æ–°åŠŸèƒ½ / New Features" >> temp_features.md
                  echo "- $commit" >> temp_features.md
                  echo "" >> temp_features.md
                  ;;
                *"fix:"*|*"ðŸ›"*)
                  echo "### ðŸ› Bug ä¿®å¤ / Bug Fixes" >> temp_fixes.md
                  echo "- $commit" >> temp_fixes.md
                  echo "" >> temp_fixes.md
                  ;;
                *"docs:"*|*"ðŸ“"*)
                  echo "### ðŸ“ æ–‡æ¡£ / Documentation" >> temp_docs.md
                  echo "- $commit" >> temp_docs.md
                  echo "" >> temp_docs.md
                  ;;
                *"style:"*|*"ðŸŽ¨"*)
                  echo "### ðŸŽ¨ ç•Œé¢ä¼˜åŒ– / UI Improvements" >> temp_style.md
                  echo "- $commit" >> temp_style.md
                  echo "" >> temp_style.md
                  ;;
                *"refactor:"*|*"â™»ï¸"*)
                  echo "### â™»ï¸ ä»£ç é‡æž„ / Refactoring" >> temp_refactor.md
                  echo "- $commit" >> temp_refactor.md
                  echo "" >> temp_refactor.md
                  ;;
                *"chore:"*|*"ðŸ“¦"*)
                  echo "### ðŸ“¦ æž„å»ºä¼˜åŒ– / Build & Dependencies" >> temp_chore.md
                  echo "- $commit" >> temp_chore.md
                  echo "" >> temp_chore.md
                  ;;
                *)
                  echo "### ðŸ”§ å…¶ä»–æ”¹è¿› / Other Improvements" >> temp_other.md
                  echo "- $commit" >> temp_other.md
                  echo "" >> temp_other.md
                  ;;
              esac
            done
            
            # åˆå¹¶åˆ†ç±»çš„æ›´æ–°æ—¥å¿—
            for file in temp_features.md temp_fixes.md temp_style.md temp_refactor.md temp_docs.md temp_chore.md temp_other.md; do
              if [ -f "$file" ]; then
                cat "$file" >> release_notes.md
                rm "$file"
              fi
            done
          else
            echo "ðŸŽ‰ **é¦–æ¬¡å‘å¸ƒ / Initial Release**" >> release_notes.md
            echo "" >> release_notes.md
            echo "è¿™æ˜¯ Claudiatron çš„é¦–ä¸ªæ­£å¼ç‰ˆæœ¬ï¼ŒåŒ…å«å®Œæ•´çš„åŠŸèƒ½ç‰¹æ€§ã€‚" >> release_notes.md
            echo "This is the first official release of Claudiatron with complete features." >> release_notes.md
            echo "" >> release_notes.md
          fi
          
          cat >> release_notes.md << 'EOF'
          
          ### ðŸ”§ ç³»ç»Ÿè¦æ±‚ / System Requirements
          
          - **Windows**: Windows 10 1809+ / Windows Server 2019+
          - **macOS**: macOS 10.15 Catalina+
          - **Linux**: Ubuntu 18.04+ / ç›¸ä¼¼å‘è¡Œç‰ˆ
          
          ### ðŸ“‹ å®‰è£…è¯´æ˜Ž / Installation
          
          1. ä»Žä¸Šæ–¹ä¸‹è½½é€‚åˆæ‚¨ç³»ç»Ÿçš„å®‰è£…åŒ… / Download the installer for your system
          2. è¿è¡Œå®‰è£…ç¨‹åº / Run the installer
          3. ç¡®ä¿å·²å®‰è£… [Claude Code CLI](https://claude.ai/code) / Ensure Claude Code CLI is installed
          4. å¯åŠ¨ Claudiatron å¼€å§‹ä½¿ç”¨ / Launch Claudiatron to get started
          
          ### ðŸŒŸ ä¸»è¦åŠŸèƒ½ / Key Features
          
          - ðŸ—‚ï¸ **é¡¹ç›®ç®¡ç†** - å¯è§†åŒ– Claude Code é¡¹ç›®æµè§ˆå’Œç®¡ç†
          - ðŸ¤– **AI ä»£ç†ç³»ç»Ÿ** - åˆ›å»ºå’Œç®¡ç†è‡ªå®šä¹‰ AI ä»£ç†
          - ðŸ“Š **ä½¿ç”¨ç»Ÿè®¡** - å®žæ—¶ç›‘æŽ§ API ä½¿ç”¨æƒ…å†µå’Œæˆæœ¬
          - ðŸ”Œ **MCP é›†æˆ** - ç®¡ç†æ¨¡åž‹ä¸Šä¸‹æ–‡åè®®æœåŠ¡å™¨
          - ðŸŒ **å›½é™…åŒ–** - å®Œæ•´çš„ä¸­è‹±æ–‡ç•Œé¢æ”¯æŒ
          - âš™ï¸ **è®¾ç½®ç®¡ç†** - ç›´è§‚çš„é…ç½®ç•Œé¢å’ŒçŽ¯å¢ƒå˜é‡ç®¡ç†
          
          ### ðŸ› é—®é¢˜åé¦ˆ / Issue Reporting
          
          å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·è®¿é—® [GitHub Issues](https://github.com/Haleclipse/Claudiatron/issues) æäº¤åé¦ˆã€‚
          
          For issues, please visit [GitHub Issues](https://github.com/Haleclipse/Claudiatron/issues).
          
          ---
          
          **å®Œæ•´æ›´æ–°æ—¥å¿—**: [View all changes](https://github.com/Haleclipse/Claudiatron/compare/$PREV_TAG...$VERSION)
          EOF
          
          echo "Generated release notes:"
          cat release_notes.md
          
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.VERSION }}
          name: "Claudiatron ${{ steps.version.outputs.VERSION }}"
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            dist/*.exe
            dist/*.msi
            dist/*.dmg
            dist/*.AppImage
            dist/*.deb
            dist/*.snap
            dist/*.zip
            dist/*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}